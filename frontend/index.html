<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TG3 AWS ‚Äî Web Segura con Contador + Predicci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg:#0f172a;
      --card:#111c33;
      --card2:#0b1224;
      --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --brand:#ff9900;
      --brand2:#4cc9f0;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --bad:#e74c3c;
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(255,153,0,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(76,201,240,.14), transparent 60%),
        radial-gradient(900px 600px at 70% 90%, rgba(46,204,113,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      padding:24px;
    }
    .wrap{width:min(980px,100%)}
    .topbar{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      margin-bottom:14px; flex-wrap:wrap;
    }
    .titlebox{display:flex; flex-direction:column; gap:6px;}
    .kicker{display:inline-flex; gap:8px; align-items:center; font-size:12px; color:var(--muted);}
    .kicker .dot{width:8px; height:8px; border-radius:50%; background:var(--brand); box-shadow:0 0 0 3px rgba(255,153,0,.15);}
    h1{margin:0; font-size:20px; letter-spacing:.2px;}
    .subtitle{margin:0; font-size:13px; color:var(--muted); line-height:1.35;}
    .badges{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      border-radius:999px; font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .badge strong{color:var(--text); font-weight:700}
    .statusDot{
      width:8px; height:8px; border-radius:50%;
      background:var(--warn); box-shadow:0 0 0 3px rgba(241,196,15,.15);
    }
    .grid{display:grid; grid-template-columns: 1.35fr .65fr; gap:14px;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} .badges{justify-content:flex-start} }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(17,28,51,.92), rgba(11,18,36,.92));
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.25px;
    }
    .valueRow{display:flex; align-items:baseline; justify-content:space-between; gap:14px; flex-wrap:wrap;}
    .value{
      font-size:64px;
      font-weight:850;
      letter-spacing:-1px;
      margin:0;
      color:var(--brand2);
      line-height:1;
    }
    .meta{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; color:var(--muted); font-size:12px;}
    .pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      padding:6px 10px;
      border-radius:999px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .progress{
      margin-top:14px; height:10px; border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(255,153,0,.85), rgba(76,201,240,.85));
      transition: width .4s ease;
    }
    .side{display:flex; flex-direction:column; gap:12px;}
    button{
      width:100%;
      cursor:pointer;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:11px 12px;
      border-radius:12px;
      font-weight:700;
      letter-spacing:.2px;
      transition: background .2s ease, transform .05s ease;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button:active{transform:translateY(1px)}
    .hint{
      padding:12px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .err{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(231,76,60,.35);
      background:rgba(231,76,60,.10);
      color:rgba(255,255,255,.92);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }
    .okBox{
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(46,204,113,.35);
      background:rgba(46,204,113,.10);
      color:rgba(255,255,255,.92);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }
    code{color:rgba(255,255,255,.92)}
    .footer{margin-top:14px; font-size:12px; color:rgba(255,255,255,.55); text-align:center;}

    .formGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 640px){
      .formGrid{grid-template-columns:1fr}
    }
    label{font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:6px;}
    input{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    .btnRow{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
    .btnRow button{width:auto; flex:1}
    .bigValue{font-size:34px; font-weight:850; color:var(--brand2); margin:0;}
    .subValue{font-size:12px; color:var(--muted); margin-top:6px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titlebox">
        <div class="kicker"><span class="dot"></span><span>Arquitecturas Cloud ¬∑ TG3</span></div>
        <h1>Web serverless: contador + inferencia (SageMaker)</h1>
        <p class="subtitle">
          Frontend privado en <strong>S3</strong> servido por <strong>CloudFront</strong>, backend en <strong>API Gateway + Lambda</strong>,
          persistencia en <strong>DynamoDB</strong>, y despliegue automatizado con <strong>CloudFormation + CodePipeline</strong>.
        </p>
      </div>
      <div class="badges">
        <div class="badge" title="Regi√≥n AWS actual del despliegue">
          üåç Regi√≥n: <strong id="region">us-east-1</strong>
        </div>
        <div class="badge" title="Estado de conexi√≥n con la API">
          <span id="statusDot" class="statusDot"></span>
          <span id="statusText">Conectando‚Ä¶</span>
        </div>
        <div class="badge" title="Host del endpoint API">
          üîó API: <strong id="apiHost">‚Äî</strong>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Contador -->
      <div class="card">
        <h2>Contador</h2>

        <div class="valueRow">
          <p id="visits" class="value">‚Äî</p>
          <div class="meta">
            <span class="pill">‚è±Ô∏è √öltima actualizaci√≥n: <span id="updatedAt">‚Äî</span></span>
            <span class="pill">üßæ Endpoint: <code>/visits</code></span>
          </div>
        </div>

        <div class="progress" aria-label="Progreso visual">
          <div id="bar" class="bar"></div>
        </div>

        <div id="errorBox" class="err"></div>
      </div>

      <!-- Controles -->
      <div class="side">
        <button id="refreshBtn" type="button">Actualizar contador</button>
        <button id="toggleAutoBtn" type="button">Auto-actualizaci√≥n: OFF</button>

        <div class="hint">
          <strong>Nota:</strong> CloudFront cachea contenido. El pipeline invalida autom√°ticamente la distribuci√≥n tras publicar el frontend.
          Si haces cambios y no los ves, espera unos segundos o recarga.
        </div>

        <div class="hint">
          <strong>Demo:</strong> refresca la p√°gina (contador) y luego prueba la inferencia con datos de ejemplo.
        </div>
      </div>
    </div>

    <!-- Predicci√≥n -->
    <div class="card" style="margin-top:14px;">
      <h2>Inferencia ¬∑ Diabetes (Logistic Regression en SageMaker)</h2>

      <div class="valueRow" style="align-items:center;">
        <div>
          <p class="bigValue" id="predTitle">‚Äî</p>
          <div class="subValue">Probabilidad estimada (0..1): <strong id="predProb">‚Äî</strong></div>
        </div>
        <div class="meta">
          <span class="pill">üßæ Endpoint: <code>/predict</code></span>
          <span class="pill">üì¶ Payload: JSON</span>
        </div>
      </div>

      <div class="formGrid" aria-label="Formulario de features">
        <label>Pregnancies <input id="Pregnancies" type="number" value="2"></label>
        <label>Glucose <input id="Glucose" type="number" value="130"></label>
        <label>BloodPressure <input id="BloodPressure" type="number" value="70"></label>
        <label>SkinThickness <input id="SkinThickness" type="number" value="20"></label>
        <label>Insulin <input id="Insulin" type="number" value="79"></label>
        <label>BMI <input id="BMI" type="number" step="0.1" value="28.1"></label>
        <label>DiabetesPedigreeFunction <input id="DiabetesPedigreeFunction" type="number" step="0.001" value="0.35"></label>
        <label>Age <input id="Age" type="number" value="29"></label>
      </div>

      <div class="btnRow">
        <button id="predictBtn" type="button">Predecir</button>
        <button id="fillExampleBtn" type="button">Cargar ejemplo</button>
      </div>

      <div id="predictOk" class="okBox"></div>
      <div id="predictErr" class="err"></div>
    </div>

    <div class="footer">
      Acceso por CloudFront (sin dominio propio) ¬∑ Infra como c√≥digo en CloudFormation
    </div>
  </div>

  <script>
    // Este valor lo reemplaza autom√°ticamente el pipeline (buildspec.yml)
    const API_BASE_URL = "REEMPLAZAR_POR_API_ENDPOINT";

    // Contador
    const visitsEl = document.getElementById("visits");
    const updatedAtEl = document.getElementById("updatedAt");
    const apiHostEl = document.getElementById("apiHost");
    const statusTextEl = document.getElementById("statusText");
    const statusDotEl = document.getElementById("statusDot");
    const barEl = document.getElementById("bar");
    const errorBoxEl = document.getElementById("errorBox");
    const refreshBtn = document.getElementById("refreshBtn");
    const toggleAutoBtn = document.getElementById("toggleAutoBtn");

    // Predicci√≥n
    const predictBtn = document.getElementById("predictBtn");
    const fillExampleBtn = document.getElementById("fillExampleBtn");
    const predTitleEl = document.getElementById("predTitle");
    const predProbEl = document.getElementById("predProb");
    const predictOkEl = document.getElementById("predictOk");
    const predictErrEl = document.getElementById("predictErr");

    const fields = ["Pregnancies","Glucose","BloodPressure","SkinThickness","Insulin","BMI","DiabetesPedigreeFunction","Age"];

    let autoOn = false;
    let autoTimer = null;

    function setStatus(state, text){
      statusTextEl.textContent = text;
      if (state === "ok"){
        statusDotEl.style.background = "var(--ok)";
        statusDotEl.style.boxShadow = "0 0 0 3px rgba(46,204,113,.15)";
      } else if (state === "bad"){
        statusDotEl.style.background = "var(--bad)";
        statusDotEl.style.boxShadow = "0 0 0 3px rgba(231,76,60,.15)";
      } else {
        statusDotEl.style.background = "var(--warn)";
        statusDotEl.style.boxShadow = "0 0 0 3px rgba(241,196,15,.15)";
      }
    }

    function showError(msg){
      errorBoxEl.style.display = "block";
      errorBoxEl.textContent = msg;
    }
    function clearError(){
      errorBoxEl.style.display = "none";
      errorBoxEl.textContent = "";
    }
    function fmt(d){
      return d.toLocaleString("es-ES", { hour12: false });
    }
    function setApiHost(){
      try{
        const u = new URL(API_BASE_URL);
        apiHostEl.textContent = u.host;
      } catch {
        apiHostEl.textContent = "‚Äî";
      }
    }
    function setBar(v){
      const pct = Math.min(100, (Number(v) % 100));
      barEl.style.width = `${pct}%`;
    }

    async function fetchVisits(){
      clearError();
      setStatus("warn", "Consultando API‚Ä¶");

      try{
        const res = await fetch(`${API_BASE_URL}/visits`, { method: "GET" });
        if (!res.ok){
          const t = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`);
        }
        const data = await res.json();
        const v = (data && typeof data.visits !== "undefined") ? data.visits : "‚Äî";

        visitsEl.textContent = v;
        updatedAtEl.textContent = fmt(new Date());
        setBar(v);
        setStatus("ok", "Conectado");
      } catch (e){
        visitsEl.textContent = "‚Äî";
        setStatus("bad", "Error");
        showError(String(e));
        console.error(e);
      }
    }

    function setAuto(on){
      autoOn = on;
      toggleAutoBtn.textContent = `AUTO-ACTUALIZACION: ${on ? "ON" : "OFF"}`;
      if (autoTimer){ clearInterval(autoTimer); autoTimer = null; }
      if (on){ autoTimer = setInterval(fetchVisits, 10000); }
    }

    function hidePredictBoxes(){
      predictOkEl.style.display = "none";
      predictOkEl.textContent = "";
      predictErrEl.style.display = "none";
      predictErrEl.textContent = "";
    }

    function fillExample(){
      const sample = {
        "Pregnancies": 6,
        "Glucose": 148,
        "BloodPressure": 72,
        "SkinThickness": 35,
        "Insulin": 0,
        "BMI": 33.6,
        "DiabetesPedigreeFunction": 0.627,
        "Age": 50
      };
      fields.forEach(k => document.getElementById(k).value = sample[k]);
    }

    async function predict(){
      hidePredictBoxes();
      predTitleEl.textContent = "Calculando‚Ä¶";
      predProbEl.textContent = "‚Äî";

      const payload = {};
      fields.forEach(k => payload[k] = Number(document.getElementById(k).value));

      try{
        const res = await fetch(`${API_BASE_URL}/predict`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data = {};
        try { data = JSON.parse(text); } catch { data = { raw: text }; }

        if (!res.ok){
          throw new Error(`HTTP ${res.status} ${res.statusText}\n${text}`);
        }

        const prob = (typeof data.probability === "number") ? data.probability : null;
        const pred = (typeof data.prediction !== "undefined") ? data.prediction : null;

        predTitleEl.textContent = (pred === 1) ? "Resultado: POSITIVO (1)" : "Resultado: NEGATIVO (0)";
        predProbEl.textContent = (prob !== null) ? prob.toFixed(4) : "‚Äî";

        predictOkEl.style.display = "block";
        predictOkEl.textContent = JSON.stringify(data, null, 2);

      } catch (e){
        predTitleEl.textContent = "Error en predicci√≥n";
        predictErrEl.style.display = "block";
        predictErrEl.textContent = String(e);
        console.error(e);
      }
    }

    refreshBtn.addEventListener("click", fetchVisits);
    toggleAutoBtn.addEventListener("click", () => setAuto(!autoOn));

    predictBtn.addEventListener("click", predict);
    fillExampleBtn.addEventListener("click", () => { fillExample(); });

    // init
    setApiHost();
    fetchVisits();
    fillExample();
  </script>
</body>
</html>
